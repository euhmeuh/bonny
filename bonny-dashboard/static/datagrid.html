<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="/common.css">
    <link rel="stylesheet" type="text/css" href="/datagrid.css">
  </head>
  <body>
    <bonny-datagrid id="1234" class="w-100"
                    data-resource="/pony"
                    data-page-size="5"
                    data-page-sizes="[5, 20, 50, 100, 300]">
      <bonny-header>Ponies</bonny-header>
      <bonny-header><bonny-filter-adder></bonny-filter-adder></bonny-header>
      <bonny-header>
        <label>Current filters:</label>
        <bonny-filter-list>
          <div class="filter-list">
            <span class="filter">Name contains "ra"<span class="filter-close"></span></span>
            <span class="filter">Status is not wandering<span class="filter-close"></span></span>
          </div>
        </bonny-filter-list>
      </bonny-header>
      <bonny-header>
        <label>Showing at least</label>
        <bonny-page-size-selector></bonny-page-size-selector>
        out of <bonny-result-count></bonny-result-count> results.
      </bonny-header>
      <bonny-header>All the ponies are displayed here.</bonny-header>
      <bonny-placeholder>Nopony is around :(</bonny-placeholder>
      <bonny-loader><div class="center mt-5 mb-5">... Loading ponies ...</div></bonny-loader>
      <bonny-column data-name="Id" data-value="id" data-sortable data-filterable></bonny-column>
      <bonny-column data-name="Name" data-value="name" data-sortable data-filterable></bonny-column>
      <bonny-column data-name="Status"
                    data-value="status"
                    data-sortable
                    data-filterable
                    data-type="['working', 'wandering', 'sleeping']">
        <span class="chip chip-green">{status}</span>
      </bonny-column>
      <bonny-column data-name="Actions">
        <a class="btn" href="/edit/{id}">Edit</a>
        <a class="btn" href="/delete/{id}">Delete</a>
      </bonny-column>
      <bonny-footer>You can add a pony by using the form below.</bonny-footer>
      <bonny-footer>
        <form action="/pony">
          <input type="text" name="new-pony-name" placeholder="Name" />
          <input type="text" name="new-pony-status" placeholder="Status" />
          <button type="submit">Add a pony</button>
        </form>
      </bonny-footer>
      <bonny-footer><bonny-pagination></bonny-pagination></bonny-footer>
    </bonny-datagrid>

  <script type="text/javascript">
    const Page = (function(){
      function onload(func) {
        document.readyState === "loading" ?
          document.addEventListener("DOMContentLoaded", func) :
          func();
      }

      function evalTemplateText(value, context) {
        return _.templateString(value, context);
      }

      function evalTemplate(element, context) {
        if (element.nodeType === Node.TEXT_NODE) {
          element.nodeValue = evalTemplateText(element.nodeValue, context);
        } else {
          _.for(Array.from(element.attributes || []), attr => {
            element.setAttribute(attr.name, evalTemplateText(attr.value, context));
          });
          _.for(Array.from(element.childNodes || []), child => {
            evalTemplate(child, context);
          });
        }
      }

      function appendChildFromTemplate(parent, template, context) {
        const element = template.cloneNode(true);
        _.for(Array.from(element.childNodes || []), child => {
          evalTemplate(child, context, (x) => x);
          parent.appendChild(child);
        });
      }

      return { onload, appendChildFromTemplate };
    }());

    const Request = (function(){
      function ajaxGet(url, success, failure) {
        var request = new XMLHttpRequest();
        request.open('GET', url, true);
        request.onreadystatechange = function () {
          if (request.readyState === XMLHttpRequest.DONE) {
            if (request.status === 200) {
              success(request.responseText)
            } else {
              failure(request.status, request.statusText, request.responseText);
            }
          }
        }
        return request.send();
      }

      function formatParams(params) {
        return "?" + _.pairs(params)
          .map(param => encodeURIComponent(param.key) + "=" + encodeURIComponent(param.value))
          .join("&");
      }

      function get(url, params) {
        return new Promise((resolve, reject) => {
          ajaxGet(
            url + formatParams(params),
            (response) => resolve(JSON.parse(response)),
            (code, status, response) =>  reject({ code, status, response })
          );
        });
      }

      return { get };
    }());

    const _ = (function(){
      function get(element, key, defaultValue) {
        return (element && element[key]) ?
          element[key] :
          defaultValue;
      }

      function forLoop(collection, func) {
        (collection || []).forEach(func);
      }

      function pairs(dict) {
        return dict ?
          Object.entries(dict).map((kv) => ({ "key": kv[0], "value": kv[1] })) :
          [];
      }

      function templateString(string, context) {
        return _.pairs(context)
          .reduce((str, val) => str.replace("{" + val.key + "}", val.value), string);
      }

      function capitalize(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
      }

      function toggle(currentValue, possibleValues) {
        const index = possibleValues.indexOf(currentValue);
        const nextValue = possibleValues[index+1];
        return nextValue || possibleValues[0];
      }

      function parseArray(string) {
        const value = eval(string);
        return Array.isArray(value) ? value : [];
      }

      return { get, "for": forLoop, pairs, templateString, capitalize, toggle, parseArray };
    }());

    const Entities = (function(){
      const filterOperators = {
        eq: "is",
        neq: "is not",
        in: "contains",
        nin: "does not contain",
        starts: "begins with",
        ends: "ends with"
      };

      function Datagrid(id) {
        this.dom = document.getElementById(id);
        this.dom.style.display = "none";
        this.table = this._createTable();
        this.init({
          resource: this.dom.dataset.resource,
          onError: this.dom.dataset["on-error"],
          columns: Array.from(this.dom.getElementsByTagName("bonny-column")),
          headers: Array.from(this.dom.getElementsByTagName("bonny-header")),
          footers: Array.from(this.dom.getElementsByTagName("bonny-footer")),
          loader: this.dom.getElementsByTagName("bonny-loader")[0],
          placeholder: this.dom.getElementsByTagName("bonny-placeholder")[0],
        });
      }

      Datagrid.prototype._getFilterableColumns = function() {
        return this.columns.filter(col => col.dataset.filterable !== undefined);
      }

      Datagrid.prototype._createTable = function() {
        const table = document.createElement("table");
        table.setAttribute("class", this.dom.getAttribute("class"));
        table.appendChild(document.createElement("thead"));
        table.appendChild(document.createElement("tbody"));
        table.appendChild(document.createElement("tfoot"));
        this.dom.parentNode.insertBefore(table, this.dom);
        return table;
      }

      Datagrid.prototype._createFilterAdder = function() {
        const form = document.createElement("form");
        const label = document.createElement("label");
        label.appendChild(document.createTextNode("Filter:"));

        const columnSelect = document.createElement("select");
        columnSelect.setAttribute("name", "new-filter-column");
        _.for(this._getFilterableColumns(), column => {
          const option = document.createElement("option");
          option.setAttribute("value", column.dataset.value);
          option.appendChild(document.createTextNode(column.dataset.name));
          columnSelect.appendChild(option);
        });

        const operatorSelect = document.createElement("select");
        operatorSelect.setAttribute("name", "new-filter-operator");
        _.for(_.pairs(filterOperators), operator => {
          const option = document.createElement("option");
          option.setAttribute("value", operator.key);
          option.appendChild(document.createTextNode(operator.value));
          operatorSelect.appendChild(option);
        });

        const valueInput = document.createElement("input");
        valueInput.setAttribute("name", "new-filter-value");
        valueInput.setAttribute("type", "text");
        const addButton = document.createElement("button");
        addButton.appendChild(document.createTextNode("Add"));

        form.appendChild(label);
        form.appendChild(columnSelect);
        form.appendChild(operatorSelect);
        form.appendChild(valueInput);
        form.appendChild(addButton);
        return form;
      }

      Datagrid.prototype._createPageSizeSelector = function() {
        const select = document.createElement("select");
        select.setAttribute("name", "page-size");
        _.for(_.parseArray(this.dom.dataset.pageSizes), size => {
          const option = document.createElement("option");
          option.setAttribute("value", size);
          option.appendChild(document.createTextNode(size));
          select.appendChild(option);
        });
        return select;
      }

      Datagrid.prototype._createPagination = function() {
        const div = document.createElement("div");
        div.setAttribute("class", "pagination");
        const firstPage = document.createElement("div");
        firstPage.setAttribute("class", "pagination-link pagination-first");
        firstPage.appendChild(document.createTextNode("First page"));
        const previousPage = document.createElement("div");
        previousPage.setAttribute("class", "pagination-link pagination-previous");
        previousPage.appendChild(document.createTextNode("Previous page"));
        const page1 = document.createElement("div");
        page1.setAttribute("class", "pagination-link");
        page1.appendChild(document.createTextNode("1"));
        const page2 = document.createElement("div");
        page2.setAttribute("class", "pagination-link pagination-current");
        page2.appendChild(document.createTextNode("2"));
        const page3 = document.createElement("div");
        page3.setAttribute("class", "pagination-link");
        page3.appendChild(document.createTextNode("3"));
        const nextPage = document.createElement("div");
        nextPage.setAttribute("class", "pagination-link pagination-next");
        nextPage.appendChild(document.createTextNode("First page"));
        const lastPage = document.createElement("div");
        lastPage.setAttribute("class", "pagination-link pagination-last");
        lastPage.appendChild(document.createTextNode("Previous page"));
        div.appendChild(firstPage);
        div.appendChild(previousPage);
        div.appendChild(page1);
        div.appendChild(page2);
        div.appendChild(page3);
        div.appendChild(nextPage);
        div.appendChild(lastPage);
        return div;
      }

      Datagrid.prototype._addRow = function(row, sectionTag) {
        const section = this.table.getElementsByTagName(sectionTag)[0];
        section.appendChild(row);
      }

      Datagrid.prototype._resetRows = function(sectionTag) {
        const section = this.table.getElementsByTagName(sectionTag)[0];
        while (section.firstChild) {
          section.removeChild(section.firstChild);
        }
      }

      Datagrid.prototype._renderSimpleRow = function(template) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.setAttribute("colspan", this.colSize);
        Page.appendChildFromTemplate(td, template);
        tr.appendChild(td);
        return tr;
      }

      Datagrid.prototype._renderHeaderRow = function() {
        const tr = document.createElement("tr");
        _.for(this.columns, (column) => {
          const th = document.createElement("th");
          if (column.dataset.sortable !== undefined) {
            th.setAttribute("class", "sortable");
            th.setAttribute("data-direction", "asc");
            th.addEventListener("click", event => this._handleSortClick(column, event.target));
          }
          const name = document.createElement("span");
          name.appendChild(document.createTextNode(column.dataset.name));
          th.appendChild(name);
          tr.appendChild(th);
        });
        return tr;
      }

      Datagrid.prototype._renderResourceRow = function(res) {
        const tr = document.createElement("tr");
        _.for(this.columns, (column) => {
          tr.appendChild(this._renderColumn(column, res));
        });
        return tr;
      }

      Datagrid.prototype._renderColumn = function(column, res) {
        const td = document.createElement("td");
        if (column.hasChildNodes()) {
          Page.appendChildFromTemplate(td, column, res);
        } else {
          td.appendChild(document.createTextNode(_.get(res, column.dataset.value, "")))
        }
        return td;
      }

      Datagrid.prototype._renderComponents = function(tagName, renderer) {
        const elements = this.dom.getElementsByTagName(tagName);
        _.for(Array.from(elements), element => {
          element.parentNode.insertBefore(renderer.call(this), element);
          element.parentNode.removeChild(element);
        })
      }

      Datagrid.prototype._showLoader = function() {
        this._resetRows("tbody");
        this._addRow(this._renderSimpleRow(this.loader), "tbody");
      };

      Datagrid.prototype._showPlaceholder = function() {
        this._resetRows("tbody");
        this._addRow(this._renderSimpleRow(this.placeholder), "tbody");
      };

      Datagrid.prototype._handleSortClick = function(column, element) {
        const direction = element.dataset.direction;
        element.dataset.direction = _.toggle(direction, ["asc", "desc"]);
        this.sortBy(column, direction);
      };

      Datagrid.prototype.init = function(config) {
        this.resource = _.get(config, "resource");
        this.onError = _.get(config, "onError",  (error) => console.log(error));
        this.columns = _.get(config, "columns", []);
        this.headers = _.get(config, "headers", []);
        this.footers = _.get(config, "footers", []);
        this.loader = _.get(config, "loader", document.createTextNode("Loading content..."));
        this.placeholder = _.get(config, "placeholder", document.createTextNode("No results."));
        this.colSize = this.columns.length;

        this._renderComponents("bonny-filter-adder", this._createFilterAdder);
        this._renderComponents("bonny-page-size-selector", this._createPageSizeSelector);
        this._renderComponents("bonny-pagination", this._createPagination);

        _.for(this.headers, (header) => {
          this._addRow(this._renderSimpleRow(header), "thead");
        });
        this._addRow(this._renderHeaderRow(), "thead");

        _.for(this.footers, (footer) => {
          this._addRow(this._renderSimpleRow(footer), "tfoot");
        });

        this.refresh();
      }

      Datagrid.prototype.refresh = function(config) {
        if (!this.resource) {
          this._showPlaceholder();
          return;
        }

        this._showLoader();

        Request.get(this.resource, config)
          .then((resources) => {
            this._resetRows("tbody");
            if (resources) {
              _.for(resources, (res) => {
                this._addRow(this._renderResourceRow(res), "tbody");
              });
            } else {
              this._addRow(this._renderSimpleRow(this.placeholder), "tbody");
            }
          })
          .catch(error => {
            this.onError(error);
            this._showPlaceholder();
          });
      };

      Datagrid.prototype.addFilter = function() {

      }

      Datagrid.prototype.removeFilter = function() {

      }

      Datagrid.prototype.sortBy = function(column, direction) {
        this.refresh({
          sort: column.dataset.value,
          direction
        });
      }

      return { Datagrid };
    }());

    function main() {
      const dg = new Entities.Datagrid("1234");
    }
    Page.onload(main);
  </script>
  </body>
</html>
