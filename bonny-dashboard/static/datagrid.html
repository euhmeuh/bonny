<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="/common.css">
  </head>
  <body>
    <table id="1234" class="w-100">
      <thead></thead>
      <tbody></tbody>
      <tfoot></tfoot>
    </table>
  <script type="text/javascript">
    const Page = (function(){
      function onload(func) {
        document.readyState === "loading" ?
          document.addEventListener("DOMContentLoaded", func) :
          func();
      }

      return { onload };
    }());

    const Request = (function(){
      function ajaxGet(url, success, failure) {
        var request = new XMLHttpRequest();
        request.open('GET', url, true);
        request.onreadystatechange = function () {
          if (request.readyState === XMLHttpRequest.DONE) {
            if (request.status === 200) {
              success(request.responseText)
            } else {
              failure(request.status, request.statusText, request.responseText);
            }
          }
        }
        return request.send();
      }

      function formatParams(params) {
        return "?" + _.pairs(params)
          .map(param => encodeURIComponent(param.key) + "=" + encodeURIComponent(param.value))
          .join("&");
      }

      function get(url, params) {
        return new Promise((resolve, reject) => {
          ajaxGet(
            url + formatParams(params),
            (response) => resolve(JSON.parse(response)),
            (code, status, response) =>  reject({ code, status, response })
          );
        });
      }

      return { get };
    }());

    const _ = (function(){
      function get(element, key, defaultValue) {
        return (element && element[key]) ?
          element[key] :
          defaultValue;
      }

      function forLoop(collection, func) {
        (collection || []).forEach(func);
      }

      function pairs(dict) {
        return dict ?
          Object.entries(dict).map((kv) => ({ "key": kv[0], "value": kv[1] })) :
          [];
      }

      function templateString(string, context) {
        return _.pairs(context)
          .reduce((str, val) => str.replace("{" + val.key + "}", val.value), string);
      }

      function capitalize(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
      }

      return { get, "for": forLoop, pairs, templateString, capitalize };
    }());

    const Entities = (function(){
      function addRow(dom, row, sectionTag) {
        const section = dom.getElementsByTagName(sectionTag)[0];
        section.appendChild(row);
      }

      function resetRows(dom, sectionTag) {
        const section = dom.getElementsByTagName(sectionTag)[0];
        while (section.firstChild) {
          section.removeChild(section.firstChild);
        }
      }

      function renderSimpleRow(body, colSize) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        if (colSize) {
          td.setAttribute("colspan", colSize);
        }
        td.appendChild(renderBody(body));
        tr.appendChild(td);
        return tr;
      }

      function renderHeaderRow(columns) {
        const tr = document.createElement("tr");
        _.for(columns, (column) => {
          const th = document.createElement("th");
          th.appendChild(document.createTextNode(column.name));
          tr.appendChild(th);
        });
        return tr;
      }

      function renderResourceRow(columns, res) {
        const tr = document.createElement("tr");
        _.for(columns, (column) => {
          tr.appendChild(renderColumn(column, res));
        });
        return tr;
      }

      function renderColumn(column, res) {
        const td = document.createElement("td");
        td.appendChild(column.body ?
                        renderBody(column.body, res) :
                        document.createTextNode(_.get(res, column.value, "")));
        return td;
      }

      function evalTemplate(value, context) {
        return (typeof value === "function") ?
          value(context) :
          _.templateString(value, context);
      }

      function renderBody(template, context) {
        const element = document.createElement(template.tag);
        _.for(_.pairs(template.attrs), (attr) => {
          element.setAttribute(attr.key, evalTemplate(attr.value, context));
        });
        if (template.text) {
          element.appendChild(
            document.createTextNode(evalTemplate(template.text, context))
          );
        } else {
          _.for(template.children, (child) => {
            element.appendChild(renderBody(child, context));
          });
        }
        return element;
      }

      function Datagrid(id, resource, config) {
        this.dom = document.getElementById(id);
        this.resource = resource;
        this.init(config);
      }

      Datagrid.prototype.init = function(config) {
        this.columns = _.get(config, "columns", []);
        this.headers = _.get(config, "headers", []);
        this.footers = _.get(config, "footers", []);
        this.loader = _.get(config, "loader", { tag: "span", text: "Loading content..." });
        this.placeholder = _.get(config, "placeholder", { tag: "span", text: "No results." });
        this.onError = _.get(config, "onError", (error) => console.log(error));
        this.colSize = this.columns.length;

        _.for(this.headers, (header) => {
          addRow(this.dom, renderSimpleRow(header, this.colSize), "thead");
        });
        addRow(this.dom, renderHeaderRow(this.columns), "thead");

        _.for(this.footers, (footer) => {
          addRow(this.dom, renderSimpleRow(footer, this.colSize), "tfoot");
        });

        this.refresh();
      }

      Datagrid.prototype.refresh = function(config) {
        this._showLoader();

        Request.get(this.resource, config)
          .then((resources) => {
            resetRows(this.dom, "tbody");
            if (resources) {
              _.for(resources, (res) => {
                addRow(this.dom, renderResourceRow(this.columns, res), "tbody");
              });
            } else {
              addRow(this.dom, renderSimpleRow(this.placeholder), "tbody");
            }
          })
          .catch(error => {
            this.onError(error);
            this._showPlaceholder();
          });
      };

      Datagrid.prototype.addFilter = function() {

      }

      Datagrid.prototype.removeFilter = function() {

      }

      Datagrid.prototype.search = function() {

      }

      Datagrid.prototype.sortBy = function(columnIndex, direction) {
        this.refresh({
          sort: _.get(_.get(this.columns, columnIndex), "value"),
          direction
        });
      }

      Datagrid.prototype._showLoader = function() {
        resetRows(this.dom, "tbody");
        addRow(this.dom, renderSimpleRow(this.loader, this.colSize), "tbody");
      };

      Datagrid.prototype._showPlaceholder = function() {
        resetRows(this.dom, "tbody");
        addRow(this.dom, renderSimpleRow(this.placeholder, this.colSize), "tbody");
      };

      return { Datagrid };
    }());

    function main() {
      const dg = new Entities.Datagrid("1234", "/pony", {
        columns: [
          { name: "Id", value: "id", sortable: true },
          { name: "Name", value: "name", type: "string", sortable: true, searchable: true },
          {
            name: "Status",
            value: "status",
            sortable: true,
            searchable: true,
            type: ["working", "wandering", "sleeping"],
            body: {
              tag: "div",
              attrs: { class: "green" },
              children: [
                { tag: "span", text: (pony) => _.capitalize(pony.status) }
              ]
            }
          },
          {
            name: "Actions",
            body: {
              tag: "div", children: [
                { tag: "a", attrs: { class: "btn", href: "/edit/{id}" }, text: "[Edit]" },
                { tag: "a", attrs: { class: "btn", href: "/delete/{id}" }, text: "[Delete]" },
              ]
            }
          }
        ],
        headers: [
          { tag: "span", text: "Ponies" },
          { tag: "span", text: "All the ponies are displayed here." }
        ],
        footers: [
          { tag: "span", text: "You can add a pony by using the form below." },
          {
            tag: "form", attrs: { action: "/pony" }, children: [
              { tag: "input", attrs: { class: "btn", type: "text", name: "new-pony-name", placeholder: "Name" } },
              { tag: "input", attrs: { class: "btn", type: "text", name: "new-pony-status", placeholder: "Status" } },
              { tag: "button", attrs: { class: "btn", type: "submit" }, text: "Add a pony" },
            ]
          }
        ],
        loader: { tag: "div", attrs: { class: "center mt-5 mb-5" }, text: "... Loading ponies ..." },
        placeholder: { tag: "span", text: "Nopony is around :(" }
      });
    }
    Page.onload(main);
  </script>
  </body>
</html>
